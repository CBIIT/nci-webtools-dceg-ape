{
  "jobDefinitionName": "${BATCH_JOB_DEFINITION}",
  "type": "container",
  "containerProperties": {
    "image": "${BATCH_WORKER_IMAGE_LATEST}",
    "command": ["bash", "-c", "dnf install -y pciutils && lspci"],
    "jobRoleArn": "${BATCH_ROLE_ARN}",
    "executionRoleArn": "${BATCH_ROLE_ARN}",
    "volumes": [
      {
        "name": "data",
        "efsVolumeConfiguration": {
          "fileSystemId": "${EFS_FILESYSTEM_ID}",
          "authorizationConfig": {
            "accessPointId": "${EFS_ACCESS_POINT_ID}",
            "iam": "ENABLED"
          },
          "transitEncryption": "ENABLED"
        }
      }
    ],
    "mountPoints": [
      {
        "sourceVolume": "data",
        "containerPath": "/data",
        "readOnly": false
      }
    ],
    "resourceRequirements": [
      { "type": "GPU", "value": "${BATCH_GPU_UNITS}" },
      { "type": "VCPU", "value": "${BATCH_CPU_UNITS}" },
      { "type": "MEMORY", "value": "${BATCH_MEMORY_UNITS}" }
    ],
    "environment": [
      { "name": "AWS_REGION", "value": "${AWS_REGION}" },
      { "name": "APP_NAME", "value": "${APP}-worker" },
      { "name": "APP_TIER", "value": "${TIER}" },
      { "name": "WORKER_TYPE", "value": "batch" },
      { "name": "VERSION", "value": "${VERSION}" },
      { "name": "COMMIT", "value": "${COMMIT}" },
      { "name": "TZ", "value": "${TZ}" }
    ],
    "secrets": [
      { "name": "BASE_URL", "valueFrom": "/analysistools/${TIER}/${APP}/base_url" },
      { "name": "LOG_LEVEL", "valueFrom": "/analysistools/${TIER}/${APP}/log_level" },
      { "name": "DATA_FOLDER", "valueFrom": "/analysistools/${TIER}/${APP}/data_folder" },
      { "name": "INPUT_FOLDER", "valueFrom": "/analysistools/${TIER}/${APP}/input_folder" },
      { "name": "OUTPUT_FOLDER", "valueFrom": "/analysistools/${TIER}/${APP}/output_folder" },
      { "name": "EMAIL_ADMIN", "valueFrom": "/analysistools/${TIER}/${APP}/email_admin" },
      { "name": "EMAIL_SMTP_HOST", "valueFrom": "/analysistools/${TIER}/${APP}/email_smtp_host" },
      { "name": "EMAIL_SMTP_PORT", "valueFrom": "/analysistools/${TIER}/${APP}/email_smtp_port" },
      { "name": "DATADOG_HOST", "valueFrom": "/analysistools/${TIER}/datadog/log_endpoint_host" },
      { "name": "DATADOG_API_KEY", "valueFrom": "/analysistools/${TIER}/datadog/api_key" }
    ],
    "logConfiguration": {
      "logDriver": "awslogs",
      "options": {
        "awslogs-group": "/analysistools/${TIER}/${APP}/batch",
        "awslogs-region": "${AWS_REGION}",
        "awslogs-stream-prefix": "batch"
      }
    }
  },
  "propagateTags": true,
  "tags": {
    "Project": "${APP}",
    "ApplicationName": "${APP}",
    "ResourceName": "${TIER}-${APP}-batch-worker",
    "EnvironmentTier": "${ENVIRONMENT_TIER}",
    "ResourceFunction": "compute",
    "Creator": "TF"
  }
}
